{% comment %} /snippets/bundle-delivery-info.liquid {% endcomment %}
{% comment %} Bundle delivery info - completely separate from existing delivery-info.liquid {% endcomment %}

{% comment %} Check for Shopify's official bundle structure {% endcomment %}
{% assign component_refs = product.selected_or_first_available_variant.metafields.custom.component_reference %}
{% assign is_bundle_title = false %}
{% if product.title contains 'Bundle' or product.title contains 'bundle' %}
  {% assign is_bundle_title = true %}
{% endif %}

{% if component_refs != blank or is_bundle_title %}

{% comment %} DEBUG: Check all possible bundle data storage methods {% endcomment %}
<script>
console.log("=== BUNDLE COMPONENT DEBUG ===");
console.log("Product title:", "{{ product.title }}");
console.log("Product handle:", "{{ product.handle }}");
console.log("Product tags:", "{{ product.tags | join: ', ' }}");
console.log("Product description:", "{{ product.description | strip_html | truncate: 200 }}");
console.log("Product type:", "{{ product.type }}");
console.log("Product vendor:", "{{ product.vendor }}");
console.log("All collections:");
{% for collection in product.collections %}
console.log("- Collection: {{ collection.handle }}");
{% endfor %}
</script>

<script type="application/json" id="bundle-delivery-info">
{
  "product": {
    "id": {{ product.id }},
    "is_bundle": true
  },
  "variants": [
    {% for variant in product.variants %}
      {% assign variant_component_refs = variant.metafields.custom.component_reference %}
      {
        "id": {{ variant.id }},
        "has_bundle_data": {% if variant_component_refs != blank %}true{% else %}false{% endif %},
        {% if variant_component_refs != blank %}
        "component_refs": {{ variant_component_refs | json }},
        "component_delivery_info": [
          {
            "product_title": "Component 1",
            "delivery_time": "5-7 Days",
            "estimated_date": "September 10-14"
          },
          {
            "product_title": "Component 2", 
            "delivery_time": "3-5 Days",
            "estimated_date": "September 8-12"
          }
        ]
        {% endif %}
      }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ]
}
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const bundleDeliveryElement = document.getElementById("bundle-delivery-info");
  if (!bundleDeliveryElement) return;

  let bundleDeliveryInfo;
  try {
    bundleDeliveryInfo = JSON.parse(bundleDeliveryElement.textContent);
  } catch (error) {
    return;
  }

  const deliveryInfoElement = document.querySelector(".delivery-info > p");
  if (!deliveryInfoElement) return;

  // Store original content for bundles
  if (typeof window.OriginalBundleEstimateText === "undefined") {
    window.OriginalBundleEstimateText = deliveryInfoElement.innerHTML;
  }

  function updateBundleDeliveryDisplay() {
    const variantInput = document.querySelector('.product__main__content input[name="id"]');
    if (!variantInput) return;

    const variantId = parseInt(variantInput.value, 10);
    const variantData = bundleDeliveryInfo.variants.find(variant => variant.id === variantId);
    
    if (variantData && variantData.has_bundle_data && variantData.component_delivery_info) {
      let bundleHTML = "<strong>Estimated delivery</strong><br>";
      
      variantData.component_delivery_info.forEach(component => {
        const deliveryText = component.estimated_date || component.delivery_time;
        if (deliveryText) {
          const quantityText = component.quantity > 1 ? ` (${component.quantity}x)` : '';
          bundleHTML += `<strong>${component.product_title}${quantityText}:</strong> ${deliveryText}<br>`;
        }
      });
      
      deliveryInfoElement.innerHTML = bundleHTML;
    } else {
      deliveryInfoElement.innerHTML = window.OriginalBundleEstimateText;
    }
  }

  function updateBundleHiddenInputs() {
    const variantInput = document.querySelector('.product__main__content input[name="id"]');
    if (!variantInput) return;

    const variantId = parseInt(variantInput.value, 10);
    const variantData = bundleDeliveryInfo.variants.find(variant => variant.id === variantId);
    
    // Clear existing bundle inputs
    const existingBundleInputs = document.querySelectorAll('input[name^="bundle_delivery_"]');
    existingBundleInputs.forEach(input => input.remove());

    if (variantData && variantData.has_bundle_data && variantData.component_delivery_info) {
      const form = document.querySelector('.product__main__content form');
      
      variantData.component_delivery_info.forEach((component, index) => {
        const deliveryText = component.estimated_date || component.delivery_time;
        if (deliveryText) {
          const quantityText = component.quantity > 1 ? ` (${component.quantity}x)` : '';
          const hiddenInput = document.createElement('input');
          hiddenInput.type = 'hidden';
          hiddenInput.name = `bundle_delivery_${index}`;
          hiddenInput.value = `${component.product_title}${quantityText}|${deliveryText}`;
          form.appendChild(hiddenInput);
        }
      });
    }
  }

  // Initial updates
  updateBundleDeliveryDisplay();
  updateBundleHiddenInputs();

  // Update on variant change
  const variantInput = document.querySelector('.product__main__content input[name="id"]');
  if (variantInput) {
    variantInput.addEventListener("change", () => {
      updateBundleDeliveryDisplay();
      updateBundleHiddenInputs();
    });
  }
});
</script>

{% endif %} 