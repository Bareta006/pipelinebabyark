{% comment %} /snippets/bundle-delivery-info.liquid {% endcomment %}
{% comment %} Bundle delivery info - completely separate from existing delivery-info.liquid {% endcomment %}

{% comment %} Try multiple ways to detect bundle {% endcomment %}
{% assign bundle_metafield = product.selected_or_first_available_variant.metafields.simple_bundles.bundled_variants %}
{% assign bundle_metafield_alt = product.metafields.simple_bundles.bundled_variants %}
{% assign is_bundle_title = false %}
{% if product.title contains 'Bundle' or product.title contains 'bundle' %}
  {% assign is_bundle_title = true %}
{% endif %}

{% comment %} Debug output {% endcomment %}
<script>
console.log("BUNDLE DEBUG:");
console.log("Product title:", "{{ product.title }}");
console.log("Contains Bundle:", {{ is_bundle_title }});
console.log("Variant metafield exists:", {% if bundle_metafield %}true{% else %}false{% endif %});
console.log("Product metafield exists:", {% if bundle_metafield_alt %}true{% else %}false{% endif %});
console.log("Variant metafield value:", "{{ bundle_metafield | escape }}");
console.log("Product metafield value:", "{{ bundle_metafield_alt | escape }}");
</script>

{% if bundle_metafield != blank or bundle_metafield_alt != blank or is_bundle_title %}

<script type="application/json" id="bundle-delivery-info">
{
  "product": {
    "id": {{ product.id }},
    "is_bundle": true
  },
  "variants": [
    {% for variant in product.variants %}
      {% assign variant_bundle_data = variant.metafields.simple_bundles.bundled_variants %}
      {
        "id": {{ variant.id }},
        "has_bundle_data": {% if variant_bundle_data %}true{% else %}false{% endif %},
        {% if variant_bundle_data %}
        "bundle_components": {{ variant_bundle_data | json }},
        "component_delivery_info": [
          {% for component in variant_bundle_data %}
            {% assign component_handle = component.product_title | handleize %}
            {% assign component_product = all_products[component_handle] %}
            {% if component_product %}
              {
                "product_title": {{ component.product_title | json }},
                "quantity": {{ component.quantity_in_bundle }},
                "delivery_time": {{ component_product.metafields.delivery.delivery_time | json }},
                "estimated_date": {{ component_product.metafields.delivery.estimated_date | json }}
              }{% unless forloop.last %},{% endunless %}
            {% endif %}
          {% endfor %}
        ]
        {% endif %}
      }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ]
}
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const bundleDeliveryElement = document.getElementById("bundle-delivery-info");
  if (!bundleDeliveryElement) return;

  let bundleDeliveryInfo;
  try {
    bundleDeliveryInfo = JSON.parse(bundleDeliveryElement.textContent);
  } catch (error) {
    return;
  }

  const deliveryInfoElement = document.querySelector(".delivery-info > p");
  if (!deliveryInfoElement) return;

  // Store original content for bundles
  if (typeof window.OriginalBundleEstimateText === "undefined") {
    window.OriginalBundleEstimateText = deliveryInfoElement.innerHTML;
  }

  function updateBundleDeliveryDisplay() {
    const variantInput = document.querySelector('.product__main__content input[name="id"]');
    if (!variantInput) return;

    const variantId = parseInt(variantInput.value, 10);
    const variantData = bundleDeliveryInfo.variants.find(variant => variant.id === variantId);
    
    if (variantData && variantData.has_bundle_data && variantData.component_delivery_info) {
      let bundleHTML = "<strong>Estimated delivery</strong><br>";
      
      variantData.component_delivery_info.forEach(component => {
        const deliveryText = component.estimated_date || component.delivery_time;
        if (deliveryText) {
          const quantityText = component.quantity > 1 ? ` (${component.quantity}x)` : '';
          bundleHTML += `<strong>${component.product_title}${quantityText}:</strong> ${deliveryText}<br>`;
        }
      });
      
      deliveryInfoElement.innerHTML = bundleHTML;
    } else {
      deliveryInfoElement.innerHTML = window.OriginalBundleEstimateText;
    }
  }

  function updateBundleHiddenInputs() {
    const variantInput = document.querySelector('.product__main__content input[name="id"]');
    if (!variantInput) return;

    const variantId = parseInt(variantInput.value, 10);
    const variantData = bundleDeliveryInfo.variants.find(variant => variant.id === variantId);
    
    // Clear existing bundle inputs
    const existingBundleInputs = document.querySelectorAll('input[name^="bundle_delivery_"]');
    existingBundleInputs.forEach(input => input.remove());

    if (variantData && variantData.has_bundle_data && variantData.component_delivery_info) {
      const form = document.querySelector('.product__main__content form');
      
      variantData.component_delivery_info.forEach((component, index) => {
        const deliveryText = component.estimated_date || component.delivery_time;
        if (deliveryText) {
          const quantityText = component.quantity > 1 ? ` (${component.quantity}x)` : '';
          const hiddenInput = document.createElement('input');
          hiddenInput.type = 'hidden';
          hiddenInput.name = `bundle_delivery_${index}`;
          hiddenInput.value = `${component.product_title}${quantityText}|${deliveryText}`;
          form.appendChild(hiddenInput);
        }
      });
    }
  }

  // Initial updates
  updateBundleDeliveryDisplay();
  updateBundleHiddenInputs();

  // Update on variant change
  const variantInput = document.querySelector('.product__main__content input[name="id"]');
  if (variantInput) {
    variantInput.addEventListener("change", () => {
      updateBundleDeliveryDisplay();
      updateBundleHiddenInputs();
    });
  }
});
</script>

{% endif %} 