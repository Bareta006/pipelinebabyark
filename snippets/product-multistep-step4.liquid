{%- liquid
  assign accessories_collection = collections['accessories']
  assign accessory_image_overrides = shop.metaobjects.accessory_image_overrides.values
-%}

<div class="multistep-step multistep-step--4" data-step="4" style="display: none;">
  <div class="step4-container">
    <h2 class="step-title">Accessories</h2>
    <div class="accessories-discount-banner">
      <svg width="34" height="34" viewBox="0 0 34 34" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g filter="url(#filter0_dd_7204_2883)">
        <path d="M3 16C3 8.26801 9.26801 2 17 2C24.732 2 31 8.26801 31 16C31 23.732 24.732 30 17 30C9.26801 30 3 23.732 3 16Z" fill="white" shape-rendering="crispEdges"/>
        <path d="M21.6668 12.5L15.2502 18.9167L12.3335 16" stroke="#00A63E" stroke-width="1.66667" stroke-linecap="round" stroke-linejoin="round"/>
        </g>
        <defs>
        <filter id="filter0_dd_7204_2883" x="0" y="0" width="34" height="34" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
        <feFlood flood-opacity="0" result="BackgroundImageFix"/>
        <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
        <feMorphology radius="1" operator="erode" in="SourceAlpha" result="effect1_dropShadow_7204_2883"/>
        <feOffset dy="1"/>
        <feGaussianBlur stdDeviation="1"/>
        <feComposite in2="hardAlpha" operator="out"/>
        <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.1 0"/>
        <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_7204_2883"/>
        <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
        <feOffset dy="1"/>
        <feGaussianBlur stdDeviation="1.5"/>
        <feComposite in2="hardAlpha" operator="out"/>
        <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.1 0"/>
        <feBlend mode="normal" in2="effect1_dropShadow_7204_2883" result="effect2_dropShadow_7204_2883"/>
        <feBlend mode="normal" in="SourceGraphic" in2="effect2_dropShadow_7204_2883" result="shape"/>
        </filter>
        </defs>
      </svg>
      <span class="accessories-discount-banner-text">
        GET 20% OFF WHEN ORDERING A SEAT
      </span>
    </div>
    <div class="accessories-grid" data-accessories-container>
      {%- if accessories_collection.products.size > 0 -%}
        {%- for accessory in accessories_collection.products limit: 20 -%}
          {%- assign accessory_image = accessory.featured_image | default: accessory.images.first -%}
          {%- assign has_variants = false -%}
          {%- if accessory.variants.size > 1 -%}
            {%- assign has_variants = true -%}
          {%- endif -%}
          
          {%- comment -%} Check if accessory has any available variants - if not, skip it {%- endcomment -%}
          {%- assign has_available = false -%}
          {%- for variant in accessory.variants -%}
            {%- if variant.available -%}
              {%- assign has_available = true -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}
          
          {%- if has_available == false -%}
            {%- continue -%}
          {%- endif -%}
          {%- assign custom_image_override = null -%}
          {%- assign product_id_str = accessory.id | append: '' -%}
          {%- for override in accessory_image_overrides -%}
            {%- if override.product_id == product_id_str -%}
              {%- assign custom_image_override = override -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}

          {%- if custom_image_override.default_image -%}
            {%- assign accessory_image = custom_image_override.default_image -%}
          {%- endif -%}

          {%- comment -%} Identify base type and find corresponding base {%- endcomment -%}
          {%- assign title_lower = accessory.title | downcase -%}
          {%- assign is_classic_base = false -%}
          {%- assign is_smart_base = false -%}
          {%- assign smart_base_variant_id = '' -%}
          {%- if title_lower contains 'base' -%}
            {%- if title_lower contains 'classic' -%}
              {%- assign is_classic_base = true -%}
              {%- comment -%} Find smart base product in collection {%- endcomment -%}
              {%- for smart_accessory in accessories_collection.products limit: 20 -%}
                {%- assign smart_title_lower = smart_accessory.title | downcase -%}
                {%- if smart_title_lower contains 'base' and smart_title_lower contains 'smart' and smart_title_lower contains 'classic' == false -%}
                  {%- for variant in smart_accessory.variants -%}
                    {%- if variant.available -%}
                      {%- assign smart_base_variant_id = variant.id -%}
                      {%- break -%}
                    {%- endif -%}
                  {%- endfor -%}
                  {%- break -%}
                {%- endif -%}
              {%- endfor -%}
            {%- elsif title_lower contains 'smart' -%}
              {%- assign is_smart_base = true -%}
            {%- endif -%}
          {%- endif -%}
          <div class="accessory-item" data-accessory-item data-product-id="{{ accessory.id }}" data-product-handle="{{ accessory.handle }}"
               {%- if is_classic_base -%}data-base-type="classic"{%- if smart_base_variant_id != '' -%} data-smart-base-variant-id="{{ smart_base_variant_id }}"{%- endif -%}{%- elsif is_smart_base -%}data-base-type="smart"{%- endif -%}
               {%- if custom_image_override.variant_images -%}
               data-variant-images="{{ custom_image_override.variant_images | escape }}"
               {%- endif -%}>
            <div class="accessory-item__image">
              {%- if accessory_image -%}
                <img src="{{ accessory_image | image_url: width: 400 }}"
                     alt="{{ accessory.title }}"
                     data-accessory-image
                     loading="lazy">
              {%- else -%}
                <div class="no-image">No Image</div>
              {%- endif -%}
            </div>
            <div class="accessory-item__content">
              <div class="accessory-item__info">
                <h4>{{ accessory.title }}</h4>
                <div class="accessory-item__pricing">
                  {%- assign discounted_price = accessory.variants.first.price | times: 0.8 | round -%}
                  <span class="accessory-item__price">${{ discounted_price | money_without_currency }}</span>
                  <span class="accessory-item__compare-price">{{ accessory.variants.first.price | money }}</span>
                </div>
              </div>

              <div class="accessory-item__variants">
              {%- if has_variants -%}
                  {%- for option in accessory.options_with_values -%}
                    <div class="accessory-variant-options">
                      {%- assign first_checked_done = false -%}
                      {%- for value in option.values -%}
                        {%- assign option_index = option.position | minus: 1 -%}
                        {%- assign variant_for_value = null -%}
                        {%- for variant in accessory.variants -%}
                          {%- if variant.options[option_index] == value -%}
                            {%- assign variant_for_value = variant -%}
                            {%- break -%}
                          {%- endif -%}
                        {%- endfor -%}

                        {%- if variant_for_value.available -%}
                        <div class="swatch__button">
                          <input type="radio"
                                 name="accessory-{{ accessory.id }}-{{ option.name | handleize }}"
                                 value="{{ value | escape }}"
                                 data-variant-option
                                 data-option-position="{{ option.position }}"
                                 data-variant-id="{{ variant_for_value.id }}"
                                 data-variant-available="true"
                                 data-variant-price="{{ variant_for_value.price }}"
                                 {%- if variant_for_value.featured_image -%}
                                 data-variant-image="{{ variant_for_value.featured_image | image_url: width: 400 }}"
                                 {%- endif -%}
                                 id="accessory-{{ accessory.id }}-{{ option.name | handleize }}-{{ forloop.index }}"
                                 {%- if forloop.first -%}
                                   {%- if first_checked_done == false -%}
                                     checked
                                     {%- assign first_checked_done = true -%}
                                   {%- endif -%}
                                 {%- endif -%}>
                          <label class="swatch__label"
                                 for="accessory-{{ accessory.id }}-{{ option.name | handleize }}-{{ forloop.index }}"
                                 data-swatch="{{ value }}">
                            <span class="visually-hidden">{{ value }}</span>
                          </label>
                        </div>
                        {%- endif -%}
                      {%- endfor -%}
                    </div>
                  {%- endfor -%}
              {%- endif -%}
              </div>

              <div class="accessory-item__action">
                {%- assign first_available_variant = accessory.variants.first -%}
                {%- for variant in accessory.variants -%}
                  {%- if variant.available -%}
                    {%- assign first_available_variant = variant -%}
                    {%- break -%}
                  {%- endif -%}
                {%- endfor -%}
                {%- if first_available_variant.available -%}
                <input type="checkbox"
                       data-accessory-checkbox
                       data-accessory-id="{{ first_available_variant.id }}"
                       data-accessory-price="{{ first_available_variant.price }}"
                       data-accessory-title="{{ accessory.title | escape }}"
                       data-product-id="{{ accessory.id }}"
                       data-variant-available="true"
                       data-delivery-time="{{ accessory.metafields.delivery.delivery_time.value }}"
                       data-delivery-date="{{ accessory.metafields.delivery.estimated_date.value }}"
                       data-variant-delivery-date="{{ first_available_variant.metafields.delivery.delivery_estimated_date.value }}"
                       id="accessory-{{ accessory.id }}"
                       class="accessory-checkbox-hidden">
                <label for="accessory-{{ accessory.id }}" class="accessory-add-btn">
                  <span class="btn-text-add">Add</span>
                  <span class="btn-text-added">
                    <span>Added</span>
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path d="M13.3333 4L6 11.3333L2.66666 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </span>
                </label>
                {%- endif -%}
              </div>
            </div>
          </div>
        {%- endfor -%}
      {%- else -%}
        <div class="accessories-loading">
          <p>No accessories available at this time.</p>
        </div>
      {%- endif -%}
    </div>

    <div class="step-actions">
      <button type="button" class="btn btn--steps action-button" data-next-step="5">
        Next
      </button>
            <button type="button" class="btn back-button btn--steps action-button" data-prev-step="3">
       <svg xmlns="http://www.w3.org/2000/svg" width="6" height="10" viewBox="0 0 6 10" fill="none">
  <path d="M4.84998 8.84998L0.849976 4.84998L4.84998 0.849976" stroke="#454545" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
</svg> Back
      </button>
    </div>
  </div>
</div>
