
<!-- Anti-flicker styles -->
<style>
  [data-gb-gate] {
    visibility: hidden;
    transition: visibility 0.2s ease-in-out;
  }
  .gb-ready [data-gb-gate], .gb-timeout [data-gb-gate] {
    visibility: visible;
  }
</style>

<script>
(function() {
  // Get SDK key from metafield
  const SDK_KEY = '{{ shop.metafields.growthbook.sdk_key }}';
  if (!SDK_KEY || SDK_KEY.includes('{' + '{')) {
    console.error('[GB] No SDK key found in growthbook.sdk_key metafield');
    return;
  }
  
  // Ensure stable user ID
  let userId = localStorage.getItem('gb_anonymous_id');
  if (!userId) {
    userId = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    localStorage.setItem('gb_anonymous_id', userId);
    localStorage.setItem('gb_stable_user_id', userId); // backward compatibility
  }
  
  // Minimal configuration for Vercel script
  window.GB_CONFIG = {
    sdkKey: SDK_KEY,
    userId: userId,
    shopifyData: {
      shop: window.Shopify?.shop || location.hostname,
      customerId: window.ShopifyAnalytics?.meta?.page?.customerId,
      pageType: window.ShopifyAnalytics?.meta?.page?.pageType,
      cart: window.Shopify?.cart
    },
    debug: /[?&]debug=1(&|$)/.test(location.search)
  };
  
  // Initialize empty test assignments for pixel
  window.gbTestAssignments = {};
  
  // Load Vercel script
  const VERSION = '2.1.0'; // Update when deploying new versions
  const script = document.createElement('script');
  script.src = `https://growthbook-scripts.vercel.app/growthbook-bundle.js?v=${VERSION}`;
  script.onerror = () => {
    console.error('[GB] Failed to load GrowthBook script');
    document.dispatchEvent(new CustomEvent('gb:load:failed'));
  };
  script.onload = () => console.log('[GB] Script loaded from Vercel');
  document.head.appendChild(script);
})();
</script>