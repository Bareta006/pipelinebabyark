{%- comment -%}
  /sections/affiliate-landing-form.liquid
  Affiliate Landing Form Section
  Handles base64 encoded referral data from URL parameter: ?info={base64}
  Format: {coupon}-{userName}-{discountAmount}
{%- endcomment -%}

{%- liquid
  assign message_size_mobile = section.settings.message_size | times: 0.85 | round
  assign form_text_size_mobile = section.settings.form_text_size | times: 0.9 | round
  assign redirect_url = section.settings.redirect_url | default: '/products/babyark-convertible-car-seat-smart'
-%}

<section class="affiliate-landing-form {{ section.settings.text_color }}"
  data-section-id="{{ section.id }}"
  data-section-type="affiliate-landing-form"
  data-redirect-url="{{ redirect_url }}"
  data-webhook-url="{{ section.settings.webhook_url }}"
  style="--PT: {{ section.settings.padding_top }}px; --PB: {{ section.settings.padding_bottom }}px; --text-alignment: {{ section.settings.text_alignment }}; --message-size: {{ section.settings.message_size }}px; --message-color: {{ section.settings.message_color }}; --form-text-size: {{ section.settings.form_text_size }}px; --text-color: {{ section.settings.text_color_custom }}; --button-color: {{ section.settings.button_color }}; --button-text-color: {{ section.settings.button_text_color }}; --message-size-mobile: {{ message_size_mobile }}px; --form-text-size-mobile: {{ form_text_size_mobile }}px;">
  
  <div class="{{ section.settings.width }} section-padding">
    <div class="affiliate-landing-form__container">
      
      {%- if section.settings.show_debug -%}
        <div class="affiliate-landing-form__debug" id="affiliate-debug-{{ section.id }}">
          <p><strong>Raw info param:</strong> <span id="raw-info-param-{{ section.id }}">-</span></p>
          <p><strong>Decoded info:</strong> <span id="decoded-info-{{ section.id }}">-</span></p>
          <p><strong>Parsed data:</strong> <span id="parsed-data-{{ section.id }}">-</span></p>
        </div>
      {%- endif -%}
      
      <div class="affiliate-landing-form__content">
        <div class="affiliate-landing-form__form-wrapper" id="affiliate-form-wrapper-{{ section.id }}">
          <p class="affiliate-landing-form__loading">Loading...</p>
        </div>
      </div>
      
    </div>
  </div>
</section>
<style>
  #shopify-section-{{ section.id }} .affiliate-landing-form__container {
    max-width: 100%;
    margin: 0 auto;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__content {
    text-align: var(--text-alignment);
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__debug {
    background: #f5f5f5;
    padding: 1rem;
    margin-bottom: 2rem;
    border: 1px solid #ddd;
    font-family: monospace;
    font-size: 12px;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__loading {
    text-align: center;
    padding: 2rem;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__welcome {
    font-size: var(--message-size);
    font-weight: 600;
    margin-bottom: 2rem;
    color: var(--message-color);
    text-align: center;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__form {
    max-width: 500px;
    margin: 0 auto;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__form-text {
    font-size: var(--form-text-size);
    margin-bottom: 1.5rem;
    color: var(--text-color);
    text-align: center;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__form-group {
    margin-bottom: 1rem;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__name-input,
  #shopify-section-{{ section.id }} .affiliate-landing-form__email-input {
    width: 100%;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__email-input:focus {
    outline: none;
    border-color: var(--button-color);
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__submit-btn {
    width: 100%;
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    font-weight: 600;
    background-color: var(--button-color);
    color: var(--button-text-color);
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: opacity 0.3s;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__submit-btn:hover {
    opacity: 0.9;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__error {
    color: #d32f2f;
    text-align: center;
    margin-top: 1rem;
    padding: 0.75rem;
    background-color: #ffebee;
    border-radius: 4px;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__success-message {
    color: #2e7d32;
    text-align: center;
    margin-top: 1rem;
    padding: 0.75rem;
    background-color: #e8f5e9;
    border-radius: 4px;
  }
  
  @media (max-width: 749px) {
    #shopify-section-{{ section.id }} .affiliate-landing-form__welcome {
      font-size: var(--message-size-mobile);
    }
    
    #shopify-section-{{ section.id }} .affiliate-landing-form__form-text {
      font-size: var(--form-text-size-mobile);
    }
  }
</style>

<script>
  (function() {
    'use strict';
    
    function initAffiliateForm() {
      const sectionId = '{{ section.id }}';
      const section = document.querySelector('[data-section-id="' + sectionId + '"]');
      const formWrapper = section ? section.querySelector('#affiliate-form-wrapper-{{ section.id }}') : null;
      
      if (!section || !formWrapper) {
        return;
      }
      
      const urlParams = new URLSearchParams(window.location.search);
      const infoParam = urlParams.get('info') || '';
      const redirectUrl = section.getAttribute('data-redirect-url') || '{{ redirect_url }}';
      const webhookUrl = section.getAttribute('data-webhook-url') || '';
      
      console.log('Webhook URL from attribute:', webhookUrl);
      console.log('Section attributes:', {
        redirectUrl: section.getAttribute('data-redirect-url'),
        webhookUrl: section.getAttribute('data-webhook-url'),
        allAttributes: Array.from(section.attributes).map(function(attr) {
          return attr.name + '=' + attr.value;
        })
      });
      
      {%- if section.settings.show_debug -%}
      const rawInfoEl = section.querySelector('#raw-info-param-{{ section.id }}');
      if (rawInfoEl) rawInfoEl.textContent = infoParam || 'Not found';
      {%- endif -%}
      
      if (!infoParam || infoParam === '') {
        formWrapper.innerHTML = '<p class="affiliate-landing-form__error">No referral information found in URL.</p>';
        return;
      }
      
      function base64Decode(str) {
        try {
          str = str.replace(/-/g, '+').replace(/_/g, '/');
          while (str.length % 4) {
            str += '=';
          }
          const decoded = atob(str);
          return decodeURIComponent(
            decoded.split('').map(function(c) {
              return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join('')
          );
        } catch (e) {
          console.error('Base64 decode error:', e);
          return null;
        }
      }
      
      function parseAffiliateData(decodedString) {
        if (!decodedString) return null;
        const parts = decodedString.split('-');
        if (parts.length >= 3) {
          return {
            coupon: parts[0],
            userName: parts.slice(1, -1).join('-'),
            discountAmount: parts[parts.length - 1],
            isValid: true
          };
        }
        return { isValid: false };
      }
      
      const decodedString = base64Decode(infoParam);
      
      {%- if section.settings.show_debug -%}
      const decodedInfoEl = section.querySelector('#decoded-info-{{ section.id }}');
      if (decodedInfoEl) decodedInfoEl.textContent = decodedString || 'Decode failed';
      {%- endif -%}
      
      if (!decodedString) {
        formWrapper.innerHTML = '<p class="affiliate-landing-form__error">Invalid referral link. Please check your link and try again.</p>';
        {%- if section.settings.show_debug -%}
        const parsedDataEl = section.querySelector('#parsed-data-{{ section.id }}');
        if (parsedDataEl) parsedDataEl.textContent = 'Decode failed';
        {%- endif -%}
        return;
      }
      
      const affiliateData = parseAffiliateData(decodedString);
      
      {%- if section.settings.show_debug -%}
      const parsedDataEl = section.querySelector('#parsed-data-{{ section.id }}');
      if (parsedDataEl) {
        if (affiliateData && affiliateData.isValid) {
          parsedDataEl.innerHTML = '<strong>Coupon:</strong> ' + affiliateData.coupon + '<br><strong>User:</strong> ' + affiliateData.userName + '<br><strong>Discount:</strong> ' + affiliateData.discountAmount;
        } else {
          parsedDataEl.textContent = 'Parse failed';
        }
      }
      {%- endif -%}
      
      if (!affiliateData || !affiliateData.isValid) {
        formWrapper.innerHTML = '<p class="affiliate-landing-form__error">Invalid referral data format. Please check your link.</p>';
        return;
      }
      
      const formId = 'affiliate-email-form-{{ section.id }}';
      const nameInputId = 'affiliate-name-input-{{ section.id }}';
      const emailInputId = 'affiliate-email-input-{{ section.id }}';
      const submitBtnId = 'affiliate-submit-btn-{{ section.id }}';
      const messageDivId = 'affiliate-form-message-{{ section.id }}';
      
      formWrapper.innerHTML = 
        '<div class="affiliate-landing-form__welcome">' +
          'Welcome, ' + affiliateData.userName + ' has give u $' + affiliateData.discountAmount + ' discount to purchase babyark!' +
        '</div>' +
        '<form class="affiliate-landing-form__form" id="' + formId + '" data-coupon="' + affiliateData.coupon + '" data-user-name="' + affiliateData.userName + '" data-discount-amount="' + affiliateData.discountAmount + '">' +
          '<p class="affiliate-landing-form__form-text">Want to get the discount? Fill in your email address</p>' +
          '<div class="affiliate-landing-form__form-group">' +
            '<input type="text" class="affiliate-landing-form__name-input" id="' + nameInputId + '" placeholder="Enter your full name" required />' +
          '</div>' +
          '<div class="affiliate-landing-form__form-group">' +
            '<input type="email" class="affiliate-landing-form__email-input" id="' + emailInputId + '" placeholder="Enter your email address" required />' +
          '</div>' +
          '<button type="submit" class="affiliate-landing-form__submit-btn" id="' + submitBtnId + '">Get Discount</button>' +
          '<div id="' + messageDivId + '"></div>' +
        '</form>';
      
      const form = section.querySelector('#' + formId);
      const nameInput = section.querySelector('#' + nameInputId);
      const emailInput = section.querySelector('#' + emailInputId);
      const submitBtn = section.querySelector('#' + submitBtnId);
      const messageDiv = section.querySelector('#' + messageDivId);
      
      if (!form || !nameInput || !emailInput || !submitBtn || !messageDiv) {
        console.error('Form elements not found');
        return;
      }
      
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const fullName = nameInput.value.trim();
        const email = emailInput.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        if (!fullName || fullName === '') {
          messageDiv.innerHTML = '<p class="affiliate-landing-form__error">Please enter your full name.</p>';
          return;
        }
        
        if (!emailRegex.test(email)) {
          messageDiv.innerHTML = '<p class="affiliate-landing-form__error">Please enter a valid email address.</p>';
          return;
        }
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Processing...';
        messageDiv.innerHTML = '';
        
        const currentWebhookUrl = section.getAttribute('data-webhook-url') || '';
        const currentRedirectUrl = section.getAttribute('data-redirect-url') || '{{ redirect_url }}';
        
        console.log('Form submit - Webhook URL:', currentWebhookUrl);
        console.log('Form submit - Redirect URL:', currentRedirectUrl);
        
        if (!currentWebhookUrl || currentWebhookUrl === '') {
          console.error('Webhook URL is empty at submit time');
          messageDiv.innerHTML = '<p class="affiliate-landing-form__error">Webhook URL not configured.</p>';
          submitBtn.disabled = false;
          submitBtn.textContent = 'Get Discount';
          return;
        }
        
        fetch(currentWebhookUrl, {
          method: 'POST',
          body: JSON.stringify({
            code: form.getAttribute('data-coupon'),
            refereeName: fullName,
            refereeEmail: email
          }),
          mode: 'no-cors'
        })
        .then(function(response) {
          console.log('=== WEBHOOK RESPONSE ===');
          console.log('Status:', response.status);
          console.log('Status Text:', response.statusText);
          console.log('OK:', response.ok);
          console.log('Response Type:', response.type);
          console.log('Note: With no-cors mode, response body cannot be read');
          return response;
        })
        .catch(function(error) {
          console.error('=== WEBHOOK ERROR ===');
          console.error('Error:', error);
          console.error('Error message:', error.message);
        });
        
        messageDiv.innerHTML = '<p class="affiliate-landing-form__success-message">Success! Redirecting...</p>';
        
        // setTimeout(function() {
        //   window.location.href = '/discount/' + form.getAttribute('data-coupon') + '?redirect=' + encodeURIComponent(currentRedirectUrl);
        // }, 500);
      });
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initAffiliateForm);
    } else {
      initAffiliateForm();
    }
  })();
</script>

{% schema %}
{
  "name": "Affiliate Landing Form",
  "tag": "section",
  "class": "section-affiliate-landing-form",
  "settings": [
    {
      "type": "header",
      "content": "Webhook Settings"
    },
    {
      "type": "url",
      "id": "webhook_url",
      "label": "Webhook URL",
      "info": "URL to send POST request when email is submitted"
    },
    {
      "type": "header",
      "content": "Redirect Settings"
    },
    {
      "type": "text",
      "id": "redirect_url",
      "label": "Redirect URL",
      "default": "/products/babyark-convertible-car-seat-smart",
      "info": "URL to redirect to after successful submission (used in /discount/{coupon}?redirect=...)"
    },
    {
      "type": "header",
      "content": "Style"
    },
    {
      "type": "range",
      "id": "message_size",
      "label": "Welcome message size",
      "min": 18,
      "max": 48,
      "step": 2,
      "default": 24,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "message_color",
      "label": "Welcome message color",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "form_text_size",
      "label": "Form text size",
      "min": 14,
      "max": 24,
      "step": 1,
      "default": 16,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "text_color_custom",
      "label": "Text color (custom)",
      "default": "#666666",
      "info": "Custom text color for form elements"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button background color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button text color",
      "default": "#ffffff"
    },
    {
      "type": "select",
      "id": "text_alignment",
      "label": "Text alignment",
      "default": "center",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ]
    },
    {
      "type": "select",
      "id": "width",
      "label": "Width",
      "default": "wrapper",
      "options": [
        { "value": "wrapper--none", "label": "Full width" },
        { "value": "wrapper--full", "label": "Full width padded" },
        { "value": "wrapper", "label": "Page width" },
        { "value": "wrapper--narrow", "label": "Page width narrow" },
        { "value": "wrapper--tiny", "label": "Page width extra narrow" }
      ]
    },
    {
      "type": "select",
      "id": "text_color",
      "label": "Text color",
      "default": "text--neutral",
      "options": [
        { "value": "text--neutral", "label": "Normal text"},
        { "value": "text--white", "label": "White"},
        { "value": "text--primary", "label": "Primary accent"},
        { "value": "text--secondary", "label": "Secondary accent"},
        { "value": "text--black", "label": "Black"},
        { "value": "text--invert--primary", "label": "Primary dark accent"},
        { "value": "text--invert--secondary", "label": "Secondary dark accent"},
        { "value": "text--invert", "label": "Inverted text color"},
        { "value": "text--bright--primary", "label": "Primary bright accent"},
        { "value": "text--bright--secondary", "label": "Secondary bright accent"}
      ]
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 180,
      "step": 2,
      "unit": "px",
      "label": "Padding top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 180,
      "step": 2,
      "unit": "px",
      "label": "Padding bottom",
      "default": 36
    },
    {
      "type": "header",
      "content": "Debug"
    },
    {
      "type": "checkbox",
      "id": "show_debug",
      "label": "Show debug information",
      "default": true,
      "info": "Disable this in production"
    }
  ],
  "presets": [
    {
      "name": "Affiliate Landing Form",
      "category": "Custom"
    }
  ]
}
{% endschema %}
