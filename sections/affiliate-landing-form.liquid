<!-- /sections/affiliate-landing-form.liquid -->
{%- comment -%}
  Affiliate Landing Form Section
  Handles base64 encoded referral data from URL parameter: ?info={base64}
  Format: {coupon}-{userName}-{discountAmount}
{%- endcomment -%}

{%- liquid
  assign info_param = request.params.info | default: ''
  assign decoded_info = ''
  assign coupon_code = ''
  assign user_name = ''
  assign discount_amount = ''
  assign is_valid = false
  
  if info_param != blank
    assign decoded_info = info_param
  endif
-%}

<section class="affiliate-landing-form section-padding"
  data-section-id="{{ section.id }}"
  data-section-type="affiliate-landing-form"
  style="
    --PT: {{ section.settings.padding_top }}px;
    --PB: {{ section.settings.padding_bottom }}px;
    --text-alignment: {{ section.settings.text_alignment }};
    --message-size: {{ section.settings.message_size }}px;
    --message-color: {{ section.settings.message_color }};
    --form-text-size: {{ section.settings.form_text_size }}px;
    --text-color: {{ section.settings.text_color }};
    --button-color: {{ section.settings.button_color }};
    --button-text-color: {{ section.settings.button_text_color }};
    --message-size-mobile: {{ section.settings.message_size | times: 0.85 }}px;
    --form-text-size-mobile: {{ section.settings.form_text_size | times: 0.9 }}px;">
  
  <div class="{{ section.settings.width }}">
    <div class="affiliate-landing-form__container">
      
      {%- comment -%} Debug info (remove in production) {%- endcomment -%}
      {%- if section.settings.show_debug -%}
        <div class="affiliate-landing-form__debug">
          <p><strong>Raw info param:</strong> {{ info_param }}</p>
          <p><strong>Decoded info:</strong> <span id="decoded-info">Decoding...</span></p>
          <p><strong>Parsed data:</strong> <span id="parsed-data">Parsing...</span></p>
        </div>
      {%- endif -%}
      
      {%- comment -%} Main form content {%- endcomment -%}
      <div class="affiliate-landing-form__content">
        {%- comment -%} Welcome message and form will be populated by JavaScript {%- endcomment -%}
        <div class="affiliate-landing-form__form-wrapper" id="affiliate-form-wrapper">
          <p class="affiliate-landing-form__loading">Loading...</p>
        </div>
      </div>
      
    </div>
  </div>
</section>

<style>
  #shopify-section-{{ section.id }} .affiliate-landing-form__container {
    max-width: 100%;
    margin: 0 auto;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__content {
    text-align: var(--text-alignment);
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__debug {
    background: #f5f5f5;
    padding: 1rem;
    margin-bottom: 2rem;
    border: 1px solid #ddd;
    font-family: monospace;
    font-size: 12px;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__loading {
    text-align: center;
    padding: 2rem;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__welcome {
    font-size: var(--message-size);
    font-weight: 600;
    margin-bottom: 2rem;
    color: var(--message-color);
    text-align: center;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__form {
    max-width: 500px;
    margin: 0 auto;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__form-text {
    font-size: var(--form-text-size);
    margin-bottom: 1.5rem;
    color: var(--text-color);
    text-align: center;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__form-group {
    margin-bottom: 1rem;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__email-input {
    width: 100%;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__email-input:focus {
    outline: none;
    border-color: var(--button-color);
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__submit-btn {
    width: 100%;
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    font-weight: 600;
    background-color: var(--button-color);
    color: var(--button-text-color);
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: opacity 0.3s;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__submit-btn:hover {
    opacity: 0.9;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__error {
    color: #d32f2f;
    text-align: center;
    margin-top: 1rem;
    padding: 0.75rem;
    background-color: #ffebee;
    border-radius: 4px;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__success-message {
    color: #2e7d32;
    text-align: center;
    margin-top: 1rem;
    padding: 0.75rem;
    background-color: #e8f5e9;
    border-radius: 4px;
  }
  
  @media (max-width: 749px) {
    #shopify-section-{{ section.id }} .affiliate-landing-form__welcome {
      font-size: var(--message-size-mobile);
    }
    
    #shopify-section-{{ section.id }} .affiliate-landing-form__form-text {
      font-size: var(--form-text-size-mobile);
    }
  }
</style>

<script>
  (function() {
    'use strict';
    
    // Get the info parameter from URL
    const urlParams = new URLSearchParams(window.location.search);
    const encodedInfo = urlParams.get('info');
    
    // Base64 decode function
    function base64Decode(str) {
      try {
        // Handle URL-safe base64
        str = str.replace(/-/g, '+').replace(/_/g, '/');
        
        // Add padding if needed
        while (str.length % 4) {
          str += '=';
        }
        
        return decodeURIComponent(
          atob(str)
            .split('')
            .map(function(c) {
              return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            })
            .join('')
        );
      } catch (e) {
        console.error('Base64 decode error:', e);
        return null;
      }
    }
    
    // Parse decoded string: {coupon}-{userName}-{discountAmount}
    function parseAffiliateData(decodedString) {
      if (!decodedString) return null;
      
      const parts = decodedString.split('-');
      
      if (parts.length >= 3) {
        // Get last part as discount amount (in case userName contains hyphens)
        const discountAmount = parts[parts.length - 1];
        // Get first part as coupon
        const coupon = parts[0];
        // Get everything in between as userName
        const userName = parts.slice(1, -1).join('-');
        
        return {
          coupon: coupon,
          userName: userName,
          discountAmount: discountAmount,
          isValid: true
        };
      }
      
      return {
        isValid: false,
        error: 'Invalid format. Expected: {coupon}-{userName}-{discountAmount}'
      };
    }
    
    // Email validation
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }
    
    // Send webhook
    async function sendWebhook(email, affiliateData) {
      const webhookUrl = '{{ section.settings.webhook_url }}';
      
      if (!webhookUrl) {
        console.error('Webhook URL not configured');
        return { success: false, error: 'Webhook URL not configured' };
      }
      
      try {
        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            email: email,
            coupon: affiliateData.coupon,
            userName: affiliateData.userName,
            discountAmount: affiliateData.discountAmount,
            timestamp: new Date().toISOString(),
            url: window.location.href
          })
        });
        
        if (!response.ok) {
          throw new Error(`Webhook failed: ${response.status} ${response.statusText}`);
        }
        
        return { success: true };
      } catch (error) {
        console.error('Webhook error:', error);
        return { success: false, error: error.message };
      }
    }
    
    // Redirect to discount page
    function redirectToDiscount(couponCode, redirectUrl) {
      const discountUrl = `/discount/${couponCode}?redirect=${encodeURIComponent(redirectUrl)}`;
      window.location.href = discountUrl;
    }
    
    // Initialize
    function initAffiliateForm() {
      const formWrapper = document.getElementById('affiliate-form-wrapper');
      const decodedInfoEl = document.getElementById('decoded-info');
      const parsedDataEl = document.getElementById('parsed-data');
      
      if (!encodedInfo) {
        if (formWrapper) {
          formWrapper.innerHTML = '<p class="affiliate-landing-form__error">No referral information found in URL.</p>';
        }
        if (decodedInfoEl) decodedInfoEl.textContent = 'No info parameter';
        if (parsedDataEl) parsedDataEl.textContent = 'No data to parse';
        return;
      }
      
      // Decode base64
      const decodedString = base64Decode(encodedInfo);
      
      if (decodedInfoEl) {
        decodedInfoEl.textContent = decodedString || 'Decode failed';
      }
      
      if (!decodedString) {
        if (formWrapper) {
          formWrapper.innerHTML = '<p class="affiliate-landing-form__error">Invalid referral link. Please check your link and try again.</p>';
        }
        if (parsedDataEl) parsedDataEl.textContent = 'Decode failed';
        return;
      }
      
      // Parse the decoded data
      const affiliateData = parseAffiliateData(decodedString);
      
      if (parsedDataEl) {
        if (affiliateData.isValid) {
          parsedDataEl.innerHTML = `
            <strong>Coupon:</strong> ${affiliateData.coupon}<br>
            <strong>User:</strong> ${affiliateData.userName}<br>
            <strong>Discount:</strong> ${affiliateData.discountAmount}
          `;
        } else {
          parsedDataEl.textContent = affiliateData.error || 'Parse failed';
        }
      }
      
      // Validate and show form
      if (affiliateData && affiliateData.isValid) {
        // Store data for form use
        window.affiliateData = affiliateData;
        
        // Get redirect URL from section settings (embedded from Liquid)
        const redirectUrl = '{{ section.settings.redirect_url | default: "/products/babyark-convertible-car-seat-smart" }}';
        
        if (formWrapper) {
          // Welcome message
          const welcomeMessage = `Welcome, ${affiliateData.userName} has give u $${affiliateData.discountAmount} discount to purchase babyark!`;
          
          formWrapper.innerHTML = `
            <div class="affiliate-landing-form__welcome">
              ${welcomeMessage}
            </div>
            
            <form class="affiliate-landing-form__form" id="affiliate-email-form">
              <p class="affiliate-landing-form__form-text">Want to get the discount? Fill in your email address</p>
              
              <div class="affiliate-landing-form__form-group">
                <input 
                  type="email" 
                  class="affiliate-landing-form__email-input" 
                  id="affiliate-email-input"
                  placeholder="Enter your email address"
                  required
                />
              </div>
              
              <button 
                type="submit" 
                class="affiliate-landing-form__submit-btn"
                id="affiliate-submit-btn"
              >
                Get Discount
              </button>
              
              <div id="affiliate-form-message"></div>
            </form>
          `;
          
          // Handle form submission
          const form = document.getElementById('affiliate-email-form');
          const emailInput = document.getElementById('affiliate-email-input');
          const submitBtn = document.getElementById('affiliate-submit-btn');
          const messageDiv = document.getElementById('affiliate-form-message');
          
          form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = emailInput.value.trim();
            
            // Validate email
            if (!isValidEmail(email)) {
              messageDiv.innerHTML = '<p class="affiliate-landing-form__error">Please enter a valid email address.</p>';
              return;
            }
            
            // Disable form during submission
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            messageDiv.innerHTML = '';
            
            // Send webhook
            const webhookResult = await sendWebhook(email, affiliateData);
            
            if (webhookResult.success) {
              // Show success message briefly
              messageDiv.innerHTML = '<p class="affiliate-landing-form__success-message">Success! Redirecting...</p>';
              
              // Redirect after short delay
              setTimeout(() => {
                redirectToDiscount(affiliateData.coupon, redirectUrl);
              }, 500);
            } else {
              // Show error
              messageDiv.innerHTML = `<p class="affiliate-landing-form__error">Failed to process request. Please try again.</p>`;
              submitBtn.disabled = false;
              submitBtn.textContent = 'Get Discount';
            }
          });
        }
      } else {
        if (formWrapper) {
          formWrapper.innerHTML = '<p class="affiliate-landing-form__error">Invalid referral data format. Please check your link.</p>';
        }
      }
    }
    
    // Run on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initAffiliateForm);
    } else {
      initAffiliateForm();
    }
  })();
</script>

{% schema %}
{
  "name": "Affiliate Landing Form",
  "tag": "section",
  "class": "section-affiliate-landing-form",
  "settings": [
    {
      "type": "header",
      "content": "Webhook Settings"
    },
    {
      "type": "url",
      "id": "webhook_url",
      "label": "Webhook URL",
      "info": "URL to send POST request when email is submitted"
    },
    {
      "type": "header",
      "content": "Redirect Settings"
    },
    {
      "type": "url",
      "id": "redirect_url",
      "label": "Redirect URL",
      "default": "/products/babyark-convertible-car-seat-smart",
      "info": "URL to redirect to after successful submission (used in /discount/{coupon}?redirect=...)"
    },
    {
      "type": "header",
      "content": "Style"
    },
    {
      "type": "range",
      "id": "message_size",
      "label": "Welcome message size",
      "min": 18,
      "max": 48,
      "step": 2,
      "default": 24,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "message_color",
      "label": "Welcome message color",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "form_text_size",
      "label": "Form text size",
      "min": 14,
      "max": 24,
      "step": 1,
      "default": 16,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#666666"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button background color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button text color",
      "default": "#ffffff"
    },
    {
      "type": "select",
      "id": "text_alignment",
      "label": "Text alignment",
      "default": "center",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ]
    },
    {
      "type": "select",
      "id": "width",
      "label": "Width",
      "default": "wrapper",
      "options": [
        { "value": "wrapper", "label": "Normal" },
        { "value": "wrapper--narrow", "label": "Narrow" },
        { "value": "wrapper--full", "label": "Full width" }
      ]
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 36,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 36,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Debug"
    },
    {
      "type": "checkbox",
      "id": "show_debug",
      "label": "Show debug information",
      "default": true,
      "info": "Disable this in production"
    }
  ],
  "presets": [
    {
      "name": "Affiliate Landing Form",
      "category": "Custom"
    }
  ]
}
{% endschema %}

