{%- comment -%}
  /sections/affiliate-landing-form.liquid
  Affiliate Landing Form Section
  Handles base64 encoded referral data from URL parameter: ?info={base64}
  Format: {coupon}-{userName}-{discountAmount}
{%- endcomment -%}

{%- liquid
  assign message_size_mobile = section.settings.message_size | times: 1 | round
  assign form_text_size_mobile = section.settings.form_text_size | times: 1 | round
  assign redirect_url = section.settings.redirect_url | default: '/products/babyark-convertible-car-seat-smart'
  assign bg_image_desktop = section.settings.background_image_desktop
  assign bg_image_mobile = section.settings.background_image_mobile | default: bg_image_desktop
  
  if bg_image_desktop
    assign bg_image_desktop_url = bg_image_desktop | image_url: width: 1920
  else
    assign bg_image_desktop_url = ''
  endif
  
  if bg_image_mobile
    assign bg_image_mobile_url = bg_image_mobile | image_url: width: 768
  else
    assign bg_image_mobile_url = bg_image_desktop_url
  endif
-%}

<section class="affiliate-landing-form {{ section.settings.text_color }}"
  data-section-id="{{ section.id }}"
  data-section-type="affiliate-landing-form"
  data-redirect-url="{{ redirect_url }}"
  data-webhook-url="{{ section.settings.webhook_url }}"
  style="--PT: {{ section.settings.padding_top }}px; --PB: {{ section.settings.padding_bottom }}px; --text-alignment: {{ section.settings.text_alignment }}; --message-size: {{ section.settings.message_size }}px; --message-color: {{ section.settings.message_color }}; --form-text-size: {{ section.settings.form_text_size }}px; --text-color: {{ section.settings.text_color_custom }}; --button-color: {{ section.settings.button_color }}; --button-text-color: {{ section.settings.button_text_color }}; --message-size-mobile: {{ message_size_mobile }}px; --form-text-size-mobile: {{ form_text_size_mobile }}px; --bg-image-desktop: {% if bg_image_desktop_url != '' %}url('{{ bg_image_desktop_url }}'){% else %}none{% endif %}; --bg-image-mobile: {% if bg_image_mobile_url != '' %}url('{{ bg_image_mobile_url }}'){% else %}none{% endif %};">
  
  <div class="{{ section.settings.width }} section-padding">
    <div class="affiliate-landing-form__container">
      
      {%- if section.settings.show_debug -%}
        <div class="affiliate-landing-form__debug" id="affiliate-debug-{{ section.id }}">
          <p><strong>Raw info param:</strong> <span id="raw-info-param-{{ section.id }}">-</span></p>
          <p><strong>Decoded info:</strong> <span id="decoded-info-{{ section.id }}">-</span></p>
          <p><strong>Parsed data:</strong> <span id="parsed-data-{{ section.id }}">-</span></p>
        </div>
      {%- endif -%}
      
      <div class="affiliate-landing-form__content">
        <div class="affiliate-landing-form__form-wrapper" id="affiliate-form-wrapper-{{ section.id }}">
          <p class="affiliate-landing-form__loading">Loading...</p>
        </div>
      </div>
      
    </div>
  </div>
</section>
<style>
  #shopify-section-{{ section.id }} .wrapper.section-padding {
    display: flex;
    align-items: center;
    justify-content: start;
}
  #shopify-section-{{ section.id }} .affiliate-landing-form {
    background-image: var(--bg-image-desktop);
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    position: relative;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__container {
    max-width: 100%;
    margin: 0 auto;
    display: flex;
    align-items: center;
    width: 100%;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__content {
    width: 510px;
    max-width: 100%;
    text-align: var(--text-alignment);
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__debug {
    background: rgba(245, 245, 245, 0.9);
    padding: 1rem;
    margin-bottom: 2rem;
    border: 1px solid #ddd;
    font-family: monospace;
    font-size: 12px;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__loading {
    text-align: left;
    padding: 2rem 0;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__welcome {
    margin-bottom: 2rem;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__welcome-title {
    color: #F6F6F6;
    font-weight: 600;
    letter-spacing: -1.08px;  
    font-size: 36px;
    margin-bottom: 1rem;
    text-align: left;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__welcome-description {
  color: rgba(255, 255, 255, 0.90);
font-weight: 400;
  font-size: var(--form-text-size);
    margin-bottom: 0;
    text-align: left;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__form {
    max-width: 100%;
    text-align: left;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__form-group {
    margin-bottom: 1rem;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__name-input,
  #shopify-section-{{ section.id }} .affiliate-landing-form__email-input,
  #shopify-section-{{ section.id }} .affiliate-landing-form__name-input:focus,
  #shopify-section-{{ section.id }} .affiliate-landing-form__email-input:focus {
    width: 100%;
    padding: 0.75rem 0.75rem;
    font-size: 1rem;
    border-bottom: 1px solid #fff;
    border-radius: 0;
    box-sizing: border-box;
    color: #fff;
  }
  

  #shopify-section-{{ section.id }} .affiliate-landing-form__submit-btn {
padding: 0.75rem 2.5rem;
    font-size: 1rem;
    font-weight: 600;
    background-color: transparent;
    color: var(--button-text-color);
    border: 1px solid #fff;
    border-radius: 54px;
    cursor: pointer;
    transition: opacity 0.3s;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__submit-btn:hover {
    opacity: 0.9;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__error {
    color: #d32f2f;
    text-align: left;
    margin-top: 1rem;
    padding: 0.75rem;
    background-color: rgba(255, 235, 238, 0.9);
    border-radius: 4px;
  }
  
  #shopify-section-{{ section.id }} .affiliate-landing-form__success-message {
    color: #2e7d32;
    text-align: left;
    margin-top: 1rem;
    padding: 0.75rem;
    background-color: rgba(232, 245, 233, 0.9);
    border-radius: 4px;
  }
  
  @media (max-width: 749px) {
    #shopify-section-{{ section.id }} .affiliate-landing-form {
      background-image: var(--bg-image-mobile);
    }
    
    #shopify-section-{{ section.id }} .affiliate-landing-form__container {
      flex-direction: column;
      align-items: flex-start;
      min-height: auto;
    }
    
    #shopify-section-{{ section.id }} .affiliate-landing-form__content {
      width: 100%;
    }
    
    #shopify-section-{{ section.id }} .affiliate-landing-form__welcome-title {
      font-size: var(--message-size-mobile);
      text-align: left;
    }
    
    #shopify-section-{{ section.id }} .affiliate-landing-form__welcome-description {
      font-size: var(--form-text-size-mobile);
      text-align: left;
    }
    
    #shopify-section-{{ section.id }} .affiliate-landing-form__loading {
      text-align: left;
    }
  }
  @media (max-width: 480px) {
      #shopify-section-{{ section.id }} .wrapper.section-padding {
    display: flex;
    align-items: start;
    justify-content: start;
}
  }
</style>

<script>
  (function() {
    'use strict';
    
    function initAffiliateForm() {
      const sectionId = '{{ section.id }}';
      const section = document.querySelector('[data-section-id="' + sectionId + '"]');
      const formWrapper = section ? section.querySelector('#affiliate-form-wrapper-{{ section.id }}') : null;
      
      if (!section || !formWrapper) {
        return;
      }
      
      const urlParams = new URLSearchParams(window.location.search);
      const infoParam = urlParams.get('info') || '';
      const redirectUrl = section.getAttribute('data-redirect-url') || '{{ redirect_url }}';
      const webhookUrl = section.getAttribute('data-webhook-url') || '';
      
      console.log('Webhook URL from attribute:', webhookUrl);
      console.log('Section attributes:', {
        redirectUrl: section.getAttribute('data-redirect-url'),
        webhookUrl: section.getAttribute('data-webhook-url'),
        allAttributes: Array.from(section.attributes).map(function(attr) {
          return attr.name + '=' + attr.value;
        })
      });
      
      {%- if section.settings.show_debug -%}
      const rawInfoEl = section.querySelector('#raw-info-param-{{ section.id }}');
      if (rawInfoEl) rawInfoEl.textContent = infoParam || 'Not found';
      {%- endif -%}
      
      if (!infoParam || infoParam === '') {
        formWrapper.innerHTML = '<p class="affiliate-landing-form__error">No referral information found in URL.</p>';
        return;
      }
      
      function base64Decode(str) {
        try {
          str = str.replace(/-/g, '+').replace(/_/g, '/');
          while (str.length % 4) {
            str += '=';
          }
          const decoded = atob(str);
          return decodeURIComponent(
            decoded.split('').map(function(c) {
              return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join('')
          );
        } catch (e) {
          console.error('Base64 decode error:', e);
          return null;
        }
      }
      
      function parseAffiliateData(decodedString) {
        if (!decodedString) return null;
        const parts = decodedString.split('-');
        if (parts.length >= 3) {
          return {
            coupon: parts[0],
            userName: parts.slice(1, -1).join('-'),
            discountAmount: parts[parts.length - 1],
            isValid: true
          };
        }
        return { isValid: false };
      }
      
      const decodedString = base64Decode(infoParam);
      
      {%- if section.settings.show_debug -%}
      const decodedInfoEl = section.querySelector('#decoded-info-{{ section.id }}');
      if (decodedInfoEl) decodedInfoEl.textContent = decodedString || 'Decode failed';
      {%- endif -%}
      
      if (!decodedString) {
        formWrapper.innerHTML = '<p class="affiliate-landing-form__error">Invalid referral link. Please check your link and try again.</p>';
        {%- if section.settings.show_debug -%}
        const parsedDataEl = section.querySelector('#parsed-data-{{ section.id }}');
        if (parsedDataEl) parsedDataEl.textContent = 'Decode failed';
        {%- endif -%}
        return;
      }
      
      const affiliateData = parseAffiliateData(decodedString);
      
      {%- if section.settings.show_debug -%}
      const parsedDataEl = section.querySelector('#parsed-data-{{ section.id }}');
      if (parsedDataEl) {
        if (affiliateData && affiliateData.isValid) {
          parsedDataEl.innerHTML = '<strong>Coupon:</strong> ' + affiliateData.coupon + '<br><strong>User:</strong> ' + affiliateData.userName + '<br><strong>Discount:</strong> ' + affiliateData.discountAmount;
        } else {
          parsedDataEl.textContent = 'Parse failed';
        }
      }
      {%- endif -%}
      
      if (!affiliateData || !affiliateData.isValid) {
        formWrapper.innerHTML = '<p class="affiliate-landing-form__error">Invalid referral data format. Please check your link.</p>';
        return;
      }
      
      const formId = 'affiliate-email-form-{{ section.id }}';
      const nameInputId = 'affiliate-name-input-{{ section.id }}';
      const emailInputId = 'affiliate-email-input-{{ section.id }}';
      const submitBtnId = 'affiliate-submit-btn-{{ section.id }}';
      const messageDivId = 'affiliate-form-message-{{ section.id }}';
      
      formWrapper.innerHTML = 
        '<div class="affiliate-landing-form__welcome">' +
          '<h2 class="affiliate-landing-form__welcome-title">' + affiliateData.userName + ' introduces you to babyark and gives you $' + affiliateData.discountAmount + ' off</h2>' +
          '<p class="affiliate-landing-form__welcome-description">' + affiliateData.userName + ' wants to invite you into the world of babyark by giving you $' + affiliateData.discountAmount + ' off your first babyark purchase. This will be automatically applied in your shopping bag.</p>' +
        '</div>' +
        '<form class="affiliate-landing-form__form" id="' + formId + '" data-coupon="' + affiliateData.coupon + '" data-user-name="' + affiliateData.userName + '" data-discount-amount="' + affiliateData.discountAmount + '">' +
          '<div class="affiliate-landing-form__form-group">' +
            '<input type="text" class="affiliate-landing-form__name-input" id="' + nameInputId + '" placeholder="Enter your full name" required />' +
          '</div>' +
          '<div class="affiliate-landing-form__form-group">' +
            '<input type="email" class="affiliate-landing-form__email-input" id="' + emailInputId + '" placeholder="Enter your email address" required />' +
          '</div>' +
          '<button type="submit" class="affiliate-landing-form__submit-btn" id="' + submitBtnId + '"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="12" viewBox="0 0 14 12" fill="none"><g clip-path="url(#clip0_7957_3086)"><path d="M12.8081 6.02989L8.03549 10.8025C7.93599 10.9019 7.80104 10.9578 7.66032 10.9578C7.51959 10.9578 7.38464 10.9019 7.28514 10.8025C7.18563 10.7029 7.12974 10.568 7.12974 10.4273C7.12974 10.2865 7.18563 10.1516 7.28514 10.0521L11.1529 6.18499H0.766613C0.625973 6.18499 0.491093 6.12912 0.391645 6.02967C0.292197 5.93023 0.236328 5.79534 0.236328 5.65471C0.236328 5.51406 0.292197 5.37919 0.391645 5.27974C0.491093 5.18029 0.625973 5.12442 0.766613 5.12442H11.1529L7.28514 1.25732C7.18563 1.15782 7.12974 1.02286 7.12974 0.882142C7.12974 0.741423 7.18563 0.606469 7.28514 0.506966C7.38464 0.407463 7.51959 0.351562 7.66032 0.351562C7.80104 0.351562 7.93599 0.407463 8.03549 0.506966L12.8081 5.27953C12.8574 5.32878 12.8965 5.38726 12.9232 5.45163C12.9499 5.51601 12.9635 5.58502 12.9635 5.65471C12.9635 5.72439 12.9499 5.79339 12.9232 5.85777C12.8965 5.92215 12.8574 5.98063 12.8081 6.02989Z" fill="white"/></g><defs><clipPath id="clip0_7957_3086"><rect width="13.1982" height="11.3127" fill="white"/></clipPath></defs></svg></button>' +
          '<div id="' + messageDivId + '"></div>' +
        '</form>';
      
      const form = section.querySelector('#' + formId);
      const nameInput = section.querySelector('#' + nameInputId);
      const emailInput = section.querySelector('#' + emailInputId);
      const submitBtn = section.querySelector('#' + submitBtnId);
      const messageDiv = section.querySelector('#' + messageDivId);
      
      if (!form || !nameInput || !emailInput || !submitBtn || !messageDiv) {
        console.error('Form elements not found');
        return;
      }
      
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const fullName = nameInput.value.trim();
        const email = emailInput.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        if (!fullName || fullName === '') {
          messageDiv.innerHTML = '<p class="affiliate-landing-form__error">Please enter your full name.</p>';
          return;
        }
        
        if (!emailRegex.test(email)) {
          messageDiv.innerHTML = '<p class="affiliate-landing-form__error">Please enter a valid email address.</p>';
          return;
        }
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Processing...';
        messageDiv.innerHTML = '';
        
        const currentWebhookUrl = section.getAttribute('data-webhook-url') || '';
        const currentRedirectUrl = section.getAttribute('data-redirect-url') || '{{ redirect_url }}';
        
        console.log('Form submit - Webhook URL:', currentWebhookUrl);
        console.log('Form submit - Redirect URL:', currentRedirectUrl);
        
        if (!currentWebhookUrl || currentWebhookUrl === '') {
          console.error('Webhook URL is empty at submit time');
          messageDiv.innerHTML = '<p class="affiliate-landing-form__error">Webhook URL not configured.</p>';
          submitBtn.disabled = false;
          submitBtn.textContent = 'Get Discount';
          return;
        }
        
        fetch(currentWebhookUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            code: form.getAttribute('data-coupon'),
            refereeName: fullName,
            refereeEmail: email
          })
        });
        
        messageDiv.innerHTML = '<p class="affiliate-landing-form__success-message">Success! Redirecting...</p>';
        
        const discountAmount = form.getAttribute('data-discount-amount');
        const redirectUrlWithDiscount = currentRedirectUrl + (currentRedirectUrl.indexOf('?') > -1 ? '&' : '?') + 'discount=' + encodeURIComponent(discountAmount);
        
        setTimeout(function() {
          window.location.href =  '/discount/' + form.getAttribute('data-coupon') + '?redirect=' + encodeURIComponent(redirectUrlWithDiscount);
        }, 500);
      });
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initAffiliateForm);
    } else {
      initAffiliateForm();
    }
  })();
</script>

{% schema %}
{
  "name": "Affiliate Landing Form",
  "tag": "section",
  "class": "section-affiliate-landing-form",
  "settings": [
    {
      "type": "header",
      "content": "Webhook Settings"
    },
    {
      "type": "url",
      "id": "webhook_url",
      "label": "Webhook URL",
      "info": "URL to send POST request when email is submitted"
    },
    {
      "type": "header",
      "content": "Redirect Settings"
    },
    {
      "type": "text",
      "id": "redirect_url",
      "label": "Redirect URL",
      "default": "/products/babyark-convertible-car-seat-smart",
      "info": "URL to redirect to after successful submission (used in /discount/{coupon}?redirect=...)"
    },
    {
      "type": "header",
      "content": "Background"
    },
    {
      "type": "image_picker",
      "id": "background_image_desktop",
      "label": "Background image (Desktop)",
      "info": "Background image for desktop and mobile (if mobile image not set)"
    },
    {
      "type": "image_picker",
      "id": "background_image_mobile",
      "label": "Background image (Mobile)",
      "info": "Optional: Different background image for mobile. If not set, desktop image will be used."
    },
    {
      "type": "header",
      "content": "Style"
    },
    {
      "type": "range",
      "id": "message_size",
      "label": "Welcome message size",
      "min": 18,
      "max": 48,
      "step": 2,
      "default": 24,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "message_color",
      "label": "Welcome message color",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "form_text_size",
      "label": "Form text size",
      "min": 14,
      "max": 24,
      "step": 1,
      "default": 16,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "text_color_custom",
      "label": "Text color (custom)",
      "default": "#666666",
      "info": "Custom text color for form elements"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button background color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button text color",
      "default": "#ffffff"
    },
    {
      "type": "select",
      "id": "text_alignment",
      "label": "Text alignment",
      "default": "center",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ]
    },
    {
      "type": "select",
      "id": "width",
      "label": "Width",
      "default": "wrapper",
      "options": [
        { "value": "wrapper--none", "label": "Full width" },
        { "value": "wrapper--full", "label": "Full width padded" },
        { "value": "wrapper", "label": "Page width" },
        { "value": "wrapper--narrow", "label": "Page width narrow" },
        { "value": "wrapper--tiny", "label": "Page width extra narrow" }
      ]
    },
    {
      "type": "select",
      "id": "text_color",
      "label": "Text color",
      "default": "text--neutral",
      "options": [
        { "value": "text--neutral", "label": "Normal text"},
        { "value": "text--white", "label": "White"},
        { "value": "text--primary", "label": "Primary accent"},
        { "value": "text--secondary", "label": "Secondary accent"},
        { "value": "text--black", "label": "Black"},
        { "value": "text--invert--primary", "label": "Primary dark accent"},
        { "value": "text--invert--secondary", "label": "Secondary dark accent"},
        { "value": "text--invert", "label": "Inverted text color"},
        { "value": "text--bright--primary", "label": "Primary bright accent"},
        { "value": "text--bright--secondary", "label": "Secondary bright accent"}
      ]
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 180,
      "step": 2,
      "unit": "px",
      "label": "Padding top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 180,
      "step": 2,
      "unit": "px",
      "label": "Padding bottom",
      "default": 36
    },
    {
      "type": "header",
      "content": "Debug"
    },
    {
      "type": "checkbox",
      "id": "show_debug",
      "label": "Show debug information",
      "default": true,
      "info": "Disable this in production"
    }
  ],
  "presets": [
    {
      "name": "Affiliate Landing Form",
      "category": "Custom"
    }
  ]
}
{% endschema %}
